{"version":3,"file":"serviceworker.js","names":["tabType: TabType","tabId: number","message: ServiceRequest","sender: MessageSender","sendResponse: (response?: any) => void"],"sources":["../typescript/messaging.ts","../typescript/serviceworker.ts"],"sourcesContent":["export enum Actions {\r\n    OpenHtmlTab = \"open_tab\",\r\n    GetTabData = \"get_tab_data\",\r\n    GetParentTabId = \"get_parent_tab_id\",\r\n    OpenHoursSettings = \"open_hours_settings\",\r\n    HoursSettingsChanged = \"open_hours_settings_changed\",\r\n    GreetingsFromParent = \"greetingsFromParent\",\r\n    GreetingsFromChild = \"greetingsFromChild\",\r\n}\r\n\r\nexport enum TabType {\r\n    Undefined= \"Undefined\",\r\n    Main = \"Main\",\r\n    HoursSettings = \"HoursSettings\",\r\n    Html = \"Html\"\r\n}\r\n\r\nexport interface ServiceRequest {\r\n    action: Actions,\r\n    senderTabType: TabType,\r\n    targetTabType: TabType,\r\n    data: any,\r\n    pageTitle?: string,\r\n    senderTabId?: number,\r\n    targetTabId?: number,\r\n}\r\n\r\nexport function sendRequest(action: Actions, from: TabType, to: TabType,  toId: number, data: any, pageTitle?: string) {\r\n    let req: ServiceRequest = {\r\n        action,\r\n        data,\r\n        pageTitle,\r\n        senderTabType: from,\r\n        targetTabType: to,\r\n        targetTabId: toId,\r\n    };\r\n    return chrome.runtime.sendMessage(req);\r\n}\r\n\r\nexport interface ServiceResponse {\r\n    result: any,\r\n    error: string,\r\n}\r\n\r\nexport async function sendGetDataRequest(sender: TabType) {\r\n    let tab = await chrome.tabs.getCurrent();\r\n    return await sendRequest(Actions.GetTabData, sender, TabType.Undefined, undefined, {tabId: tab.id});\r\n}\r\n\r\nexport type MessageHandler = {\r\n    getListener: () => (request: ServiceRequest, _sender, _sendResponse) => void;\r\n    onMessageForMyTabType: (callback: (msg: ServiceRequest) => void) => MessageHandler;\r\n    onMessageForMe: (callback: (msg: ServiceRequest) => void) => MessageHandler;\r\n    onData: (callback: (data: any) => void) => MessageHandler;\r\n}\r\n\r\nexport interface InternalMessageHandler extends MessageHandler {\r\n    _onMessageForMyTabType(request: ServiceRequest): void;\r\n    _onMessageForMe(request: ServiceRequest): void;\r\n    _onData(data: any): void;\r\n}\r\n\r\nexport function createMessageHandler(tabType: TabType): MessageHandler {\r\n    let handler:InternalMessageHandler = {\r\n        getListener: function () {\r\n            let self: InternalMessageHandler = this;\r\n            return async function onMessage(request: ServiceRequest, _sender, _sendResponse) {\r\n                console.log(`blank received: `, request);\r\n                if (request.targetTabType === tabType) {\r\n                    self._onMessageForMyTabType?.(request);\r\n                    let tab = await chrome.tabs.getCurrent();\r\n                    if (request.targetTabId === tab.id) {\r\n                        self._onMessageForMe?.(request)\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        onMessageForMyTabType: function (callback: (msg: ServiceRequest) => void): MessageHandler {\r\n            this._onMessageForMyTabType = callback;\r\n            return this;\r\n        },\r\n        onMessageForMe: function (callback: (msg: ServiceRequest) => void): MessageHandler {\r\n            this._onMessageForMe = callback;\r\n            return this;\r\n        },\r\n        onData: function (callback: (data: any) => void): MessageHandler {\r\n            this._onData = callback;\r\n            return this;\r\n        },\r\n        _onMessageForMyTabType: undefined,\r\n        _onMessageForMe: undefined,\r\n        _onData: undefined\r\n    };\r\n    document.addEventListener(\"DOMContentLoaded\", async () => {\r\n        let res = await sendGetDataRequest(tabType);\r\n        handler._onData?.(res);\r\n    });\r\n    return handler;\r\n}","import MessageSender = chrome.runtime.MessageSender;\r\nimport {Actions, ServiceRequest, TabType} from \"./messaging\";\r\n\r\nlet defaultOptions = { //todo: integrate in options.ts.\r\n    showDebug: true,\r\n    showNotAssignedClasses: true,\r\n    markOtherAcademies: true,\r\n    otherAcademies: \"\"\r\n};\r\n\r\nchrome.runtime.onInstalled.addListener(() => {\r\n    console.log(\"installed.\");\r\n    chrome.storage.sync.get(\r\n        defaultOptions,\r\n        (items) => {\r\n            chrome.storage.sync.set(\r\n                {...defaultOptions, ...items},\r\n                () => {\r\n                    console.log(\"Options initialized\");\r\n                }\r\n            );\r\n        }\r\n    );\r\n});\r\n\r\nchrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {\r\n    console.log(\"service worker: tab updated: \", tabId, changeInfo.status);\r\n});\r\n\r\nchrome.tabs.onRemoved.addListener(function(tabId, removeInfo) {\r\n    console.log(\"service worker: tab removed: \", tabId);\r\n});\r\n\r\nlet global_request = {};\r\n\r\nchrome.runtime.onMessage.addListener( onMessage);\r\n\r\nasync function getTabId(tabType: TabType) {\r\n    let data = await chrome.storage.session.get(tabType);\r\n    console.log(data);\r\n    let tabId = data[tabType];\r\n    return parseInt(tabId);\r\n}\r\n\r\nasync function setTabId(tabType: TabType, tabId: number) {\r\n    let data = {};\r\n    data[tabType] = tabId.toString();\r\n    await chrome.storage.session.set(data);\r\n}\r\n\r\nfunction onMessage(message: ServiceRequest, sender: MessageSender, sendResponse: (response?: any) => void) {\r\n    switch (message.action) {\r\n        case Actions.OpenHtmlTab:\r\n            let url = chrome.runtime.getURL(\"resources/blank.html\");\r\n            global_request = message;\r\n            if(message.senderTabType === TabType.Main)\r\n                setTabId(TabType.Main, sender.tab.id);\r\n            chrome.tabs.create({url}).then(_tab => {\r\n                sendResponse({tabId: _tab.id});\r\n            });\r\n            return true;\r\n        case Actions.OpenHoursSettings:\r\n            global_request = message;\r\n            setTabId(TabType.Main, sender.tab.id);\r\n            //todo: if already exists: activate?\r\n            chrome.tabs.create({url: chrome.runtime.getURL(\"resources/teacherHoursSetup.html\")}).then(tab => {\r\n                sendResponse({tabId: tab.id}); //todo: make a Response type.\r\n            });\r\n            return true; //needed because sendResponse is called asynchronously.\r\n        case Actions.GetTabData: //todo: move to sender instead of worker?\r\n            sendResponse(global_request);\r\n            break;\r\n        case Actions.GetParentTabId:\r\n            sendResponse(getTabId(TabType.Main));\r\n            break;\r\n        case Actions.GreetingsFromChild:\r\n        default:\r\n            getTabId(message.targetTabType).then(id => {\r\n                chrome.tabs.sendMessage(id, message).then(r => {});\r\n            });\r\n            break;\r\n    }\r\n}\r\n"],"mappings":";;;;;AAAA,IAAY,8CAAL;AACH;AACA;AACA;AACA;AACA;AACA;AACA;;AACH;AAED,IAAY,8CAAL;AACH;AACA;AACA;AACA;;AACH;;;;ACZD,IAAI,iBAAiB;CACjB,WAAW;CACX,wBAAwB;CACxB,oBAAoB;CACpB,gBAAgB;AACnB;AAED,OAAO,QAAQ,YAAY,YAAY,MAAM;AACzC,SAAQ,IAAI,aAAa;AACzB,QAAO,QAAQ,KAAK,IAChB,gBACA,CAAC,UAAU;AACP,SAAO,QAAQ,KAAK,IAChB;GAAC,GAAG;GAAgB,GAAG;EAAM,GAC7B,MAAM;AACF,WAAQ,IAAI,sBAAsB;EACrC,EACJ;CACJ,EACJ;AACJ,EAAC;AAEF,OAAO,KAAK,UAAU,YAAY,SAAS,OAAO,YAAY,KAAK;AAC/D,SAAQ,IAAI,iCAAiC,OAAO,WAAW,OAAO;AACzE,EAAC;AAEF,OAAO,KAAK,UAAU,YAAY,SAAS,OAAO,YAAY;AAC1D,SAAQ,IAAI,iCAAiC,MAAM;AACtD,EAAC;AAEF,IAAI,iBAAiB,CAAE;AAEvB,OAAO,QAAQ,UAAU,YAAa,UAAU;AAEhD,eAAe,SAASA,SAAkB;CACtC,IAAI,OAAO,MAAM,OAAO,QAAQ,QAAQ,IAAI,QAAQ;AACpD,SAAQ,IAAI,KAAK;CACjB,IAAI,QAAQ,KAAK;AACjB,QAAO,SAAS,MAAM;AACzB;AAED,eAAe,SAASA,SAAkBC,OAAe;CACrD,IAAI,OAAO,CAAE;AACb,MAAK,WAAW,MAAM,UAAU;AAChC,OAAM,OAAO,QAAQ,QAAQ,IAAI,KAAK;AACzC;AAED,SAAS,UAAUC,SAAyBC,QAAuBC,cAAwC;AACvG,SAAQ,QAAQ,QAAhB;EACI,KAAK,QAAQ;GACT,IAAI,MAAM,OAAO,QAAQ,OAAO,uBAAuB;AACvD,oBAAiB;AACjB,OAAG,QAAQ,kBAAkB,QAAQ,KACjC,UAAS,QAAQ,MAAM,OAAO,IAAI,GAAG;AACzC,UAAO,KAAK,OAAO,EAAC,IAAI,EAAC,CAAC,KAAK,UAAQ;AACnC,iBAAa,EAAC,OAAO,KAAK,GAAG,EAAC;GACjC,EAAC;AACF,UAAO;EACX,KAAK,QAAQ;AACT,oBAAiB;AACjB,YAAS,QAAQ,MAAM,OAAO,IAAI,GAAG;AAErC,UAAO,KAAK,OAAO,EAAC,KAAK,OAAO,QAAQ,OAAO,mCAAmC,CAAC,EAAC,CAAC,KAAK,SAAO;AAC7F,iBAAa,EAAC,OAAO,IAAI,GAAG,EAAC;GAChC,EAAC;AACF,UAAO;EACX,KAAK,QAAQ;AACT,gBAAa,eAAe;AAC5B;EACJ,KAAK,QAAQ;AACT,gBAAa,SAAS,QAAQ,KAAK,CAAC;AACpC;EACJ,KAAK,QAAQ;EACb;AACI,YAAS,QAAQ,cAAc,CAAC,KAAK,QAAM;AACvC,WAAO,KAAK,YAAY,IAAI,QAAQ,CAAC,KAAK,OAAK,CAAE,EAAC;GACrD,EAAC;AACF;CACP;AACJ"}