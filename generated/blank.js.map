{"version":3,"file":"blank.js","names":["action: Actions","from: TabType","to: TabType","toId: number","data: any","pageTitle?: string","req: ServiceRequest","sender: TabType","dataType: DataRequestTypes","params: T","dataRequestInfo: DataRequestInfo<T>","tabType: TabType","handler:InternalMessageHandler","self: InternalMessageHandler","request: ServiceRequest","callback: (msg: ServiceRequest) => void","callback: (data: any) => void","handler","data: HtmlData","_: Event"],"sources":["../typescript/messaging.ts","../typescript/blank.ts"],"sourcesContent":["import {DataCacheId} from \"./globals\";\r\n\r\nexport enum Actions {\r\n    OpenHtmlTab = \"open_tab\",\r\n    RequestTabData = \"request_tab_data\",\r\n    TabData = \"tab_data\",\r\n    GetParentTabId = \"get_parent_tab_id\",\r\n    OpenHoursSettings = \"open_hours_settings\",\r\n    HoursSettingsChanged = \"open_hours_settings_changed\",\r\n    GreetingsFromParent = \"greetingsFromParent\",\r\n    GreetingsFromChild = \"greetingsFromChild\",\r\n}\r\n\r\nexport enum TabType {\r\n    Undefined= \"Undefined\",\r\n    Main = \"Main\",\r\n    HoursSettings = \"HoursSettings\",\r\n    Html = \"Html\"\r\n}\r\n\r\nexport interface ServiceRequest {\r\n    action: Actions,\r\n    senderTabType: TabType,\r\n    targetTabType: TabType,\r\n    data: any,\r\n    pageTitle?: string,\r\n    senderTabId?: number,\r\n    targetTabId?: number,\r\n}\r\n\r\nexport function sendRequest(action: Actions, from: TabType, to: TabType,  toId: number, data: any, pageTitle?: string) {\r\n    let req: ServiceRequest = {\r\n        action,\r\n        data,\r\n        pageTitle,\r\n        senderTabType: from,\r\n        targetTabType: to,\r\n        targetTabId: toId,\r\n    };\r\n    return chrome.runtime.sendMessage(req);\r\n}\r\n\r\nexport interface ServiceResponse {\r\n    result: any,\r\n    error: string,\r\n}\r\n\r\nexport enum DataRequestTypes {\r\n    HoursSettings = \"HoursSettings\",\r\n    Html = \"Html\" //todo: this is just for tests.\r\n}\r\n\r\nexport type HourSettingsDataRequestParams = {\r\n    schoolYear: string,\r\n}\r\n\r\nexport type HtmlDataRequestParams = {\r\n    cacheId: DataCacheId,\r\n}\r\n\r\nexport type RequestParams = HourSettingsDataRequestParams | HtmlDataRequestParams;\r\nexport interface DataRequestInfo<Params extends RequestParams> {\r\n    tabId: number,\r\n    dataType: DataRequestTypes,\r\n    params: Params,\r\n}\r\n\r\nexport async function sendDataRequest<T extends RequestParams>(sender: TabType, dataType: DataRequestTypes, params: T) {\r\n    let tab = await chrome.tabs.getCurrent();\r\n    let dataRequestInfo: DataRequestInfo<T> = {\r\n        tabId: tab.id,\r\n        dataType: dataType,\r\n        params\r\n    };\r\n    await sendRequest(Actions.RequestTabData, sender, TabType.Undefined, undefined, dataRequestInfo);\r\n}\r\n\r\nexport type MessageHandler = {\r\n    getListener: () => (request: ServiceRequest, _sender, _sendResponse) => void;\r\n    onMessageForMyTabType: (callback: (msg: ServiceRequest) => void) => MessageHandler;\r\n    onMessageForMe: (callback: (msg: ServiceRequest) => void) => MessageHandler;\r\n    onData: (callback: (data: any) => void) => MessageHandler;\r\n}\r\n\r\nexport interface InternalMessageHandler extends MessageHandler {\r\n    _onMessageForMyTabType(request: ServiceRequest): void;\r\n    _onMessageForMe(request: ServiceRequest): void;\r\n    _onData(data: any): void;\r\n}\r\n\r\nexport function createMessageHandler(tabType: TabType): MessageHandler {\r\n    let handler:InternalMessageHandler = {\r\n        getListener: function () {\r\n            let self: InternalMessageHandler = this;\r\n            return async function onMessage(request: ServiceRequest, _sender, _sendResponse) {\r\n                console.log(`tab received: `, request);\r\n                if (request.targetTabType === tabType) {\r\n                    self._onMessageForMyTabType?.(request);\r\n                    let tab = await chrome.tabs.getCurrent();\r\n                    if (request.targetTabId === tab.id) {\r\n                        if(request.action === Actions.TabData && self._onData) {\r\n                            self._onData(request);\r\n                        } else {\r\n                            self._onMessageForMe?.(request);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        onMessageForMyTabType: function (callback: (msg: ServiceRequest) => void): MessageHandler {\r\n            this._onMessageForMyTabType = callback;\r\n            return this;\r\n        },\r\n        onMessageForMe: function (callback: (msg: ServiceRequest) => void): MessageHandler {\r\n            this._onMessageForMe = callback;\r\n            return this;\r\n        },\r\n        onData: function (callback: (data: any) => void): MessageHandler {\r\n            this._onData = callback;\r\n            return this;\r\n        },\r\n        _onMessageForMyTabType: undefined,\r\n        _onMessageForMe: undefined,\r\n        _onData: undefined\r\n    };\r\n    return handler;\r\n}","import {Actions, createMessageHandler, DataRequestTypes, HourSettingsDataRequestParams, HtmlDataRequestParams, sendDataRequest, sendRequest, TabType} from \"./messaging\";\r\nimport {DataCacheId, HtmlData} from \"./globals\";\r\n\r\nlet handler  = createMessageHandler(TabType.Html);\r\n\r\nchrome.runtime.onMessage.addListener(handler.getListener());\r\n\r\nhandler\r\n    .onMessageForMyTabType(msg => {\r\n        let data: HtmlData = JSON.parse(msg.data);\r\n        console.log(\"message for my tab type: \", msg);\r\n        document.getElementById(\"container\").innerHTML = data.html;\r\n        document.title = data.title;\r\n    })\r\n    .onMessageForMe(msg => {\r\n        console.log(\"message for me: \", msg);\r\n        document.getElementById(\"container\").innerHTML = \"DATA:\" + msg.data;\r\n    })\r\n    .onData((data: HtmlData) => {\r\n        console.log(\"requested data received: \");\r\n        console.log(data);\r\n        document.getElementById(\"container\").innerHTML = data.html;\r\n        document.title = data.title;\r\n    });\r\n\r\n//todo: the data request is never received by the calling tab. So, a window refresh will fail. Add an onMessage listener to the calling tab.\r\nasync function onDocumentLoaded(this: Document, _: Event) {\r\n    let params = new URLSearchParams(document.location.search);\r\n    let cacheId = params.get(\"cacheId\") as DataCacheId;\r\n    console.log(\"requesting data for cacheId: \", cacheId);\r\n    await sendDataRequest<HtmlDataRequestParams>(TabType.Html, DataRequestTypes.Html, {cacheId});\r\n}\r\n\r\ndocument.addEventListener(\"DOMContentLoaded\", onDocumentLoaded);\r\n"],"mappings":";;;;;AAEA,IAAY,8CAAL;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACH;AAED,IAAY,8CAAL;AACH;AACA;AACA;AACA;;AACH;AAYD,SAAgB,YAAYA,QAAiBC,MAAeC,IAAcC,MAAcC,MAAWC,WAAoB;CACnH,IAAIC,MAAsB;EACtB;EACA;EACA;EACA,eAAe;EACf,eAAe;EACf,aAAa;CAChB;AACD,QAAO,OAAO,QAAQ,YAAY,IAAI;AACzC;AAOD,IAAY,gEAAL;AACH;AACA;;AACH;AAiBD,eAAsB,gBAAyCC,QAAiBC,UAA4BC,QAAW;CACnH,IAAI,MAAM,MAAM,OAAO,KAAK,YAAY;CACxC,IAAIC,kBAAsC;EACtC,OAAO,IAAI;EACD;EACV;CACH;AACD,OAAM,YAAY,QAAQ,gBAAgB,QAAQ,QAAQ,mBAAsB,gBAAgB;AACnG;AAeD,SAAgB,qBAAqBC,SAAkC;CACnE,IAAIC,YAAiC;EACjC,aAAa,WAAY;GACrB,IAAIC,OAA+B;AACnC,UAAO,eAAe,UAAUC,SAAyB,SAAS,eAAe;AAC7E,YAAQ,KAAK,iBAAiB,QAAQ;AACtC,QAAI,QAAQ,kBAAkB,SAAS;AACnC,UAAK,yBAAyB,QAAQ;KACtC,IAAI,MAAM,MAAM,OAAO,KAAK,YAAY;AACxC,SAAI,QAAQ,gBAAgB,IAAI,GAC5B,KAAG,QAAQ,WAAW,QAAQ,WAAW,KAAK,QAC1C,MAAK,QAAQ,QAAQ;SAErB,MAAK,kBAAkB,QAAQ;IAG1C;GACJ;EACJ;EACD,uBAAuB,SAAUC,UAAyD;AACtF,QAAK,yBAAyB;AAC9B,UAAO;EACV;EACD,gBAAgB,SAAUA,UAAyD;AAC/E,QAAK,kBAAkB;AACvB,UAAO;EACV;EACD,QAAQ,SAAUC,UAA+C;AAC7D,QAAK,UAAU;AACf,UAAO;EACV;EACD;EACA;EACA;CACH;AACD,QAAOC;AACV;;;;AC3HD,IAAI,UAAW,qBAAqB,QAAQ,KAAK;AAEjD,OAAO,QAAQ,UAAU,YAAY,QAAQ,aAAa,CAAC;AAE3D,QACK,sBAAsB,SAAO;CAC1B,IAAIC,OAAiB,KAAK,MAAM,IAAI,KAAK;AACzC,SAAQ,IAAI,6BAA6B,IAAI;AAC7C,UAAS,eAAe,YAAY,CAAC,YAAY,KAAK;AACtD,UAAS,QAAQ,KAAK;AACzB,EAAC,CACD,eAAe,SAAO;AACnB,SAAQ,IAAI,oBAAoB,IAAI;AACpC,UAAS,eAAe,YAAY,CAAC,YAAY,UAAU,IAAI;AAClE,EAAC,CACD,OAAO,CAACA,SAAmB;AACxB,SAAQ,IAAI,4BAA4B;AACxC,SAAQ,IAAI,KAAK;AACjB,UAAS,eAAe,YAAY,CAAC,YAAY,KAAK;AACtD,UAAS,QAAQ,KAAK;AACzB,EAAC;AAGN,eAAe,iBAAiCC,GAAU;CACtD,IAAI,SAAS,IAAI,gBAAgB,SAAS,SAAS;CACnD,IAAI,UAAU,OAAO,IAAI,UAAU;AACnC,SAAQ,IAAI,iCAAiC,QAAQ;AACrD,OAAM,gBAAuC,QAAQ,MAAM,iBAAiB,MAAM,EAAC,QAAQ,EAAC;AAC/F;AAED,SAAS,iBAAiB,oBAAoB,iBAAiB"}